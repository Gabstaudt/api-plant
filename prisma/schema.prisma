generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN_MASTER
  ADMIN
  VIEWER
}

enum UserStatus {
  ATIVO
  PENDENTE
  BLOQUEADO
}

enum StatusReading {
  NORMAL
  ATENCAO
  CRITICO
}

enum AlertSeverity {
  CRITICO
  MEDIO
  BAIXO
}

enum AlertCondition {
  ABOVE_IDEAL
  BELOW_IDEAL
  EQUALS
  GREATER_THAN
  LESS_THAN
}

enum AlertStatus {
  ATIVO
  RESOLVIDO
}


model User {
  id           Int       @id @default(autoincrement())
  fullName     String
  email        String    @unique
  password     String
  role         Role      @default(VIEWER)
  status       UserStatus @default(PENDENTE)
  requestedRole Role?
  dateOfBirth  DateTime?
  lastLoginAt  DateTime?
  createdAt    DateTime  @default(now())

  ecosystemId Int?
  ecosystem Ecosystem? @relation(fields: [ecosystemId], references: [id], onDelete: SetNull)

  plants Plant[]
  sensors Sensor[]
  alertRules AlertRule[]
  resolvedAlerts Alert[] @relation("AlertResolvedBy")
  alerts Alert[]
  alertEvents AlertEvent[]
}

model Ecosystem {
  id Int @id @default(autoincrement())
  name String
  code String @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users User[]
}

model Plant {
  id Int @id @default(autoincrement())
  plantName String
  species String
  location String
  notes String?
  tempUnit String?
  tempMax Decimal?
  tempMin Decimal?
  umiUnit String?
  umiMax Decimal?
  umiMin Decimal?
  lightUnit String?
  lightMax Decimal?
  lightMin Decimal?
  phUnit String?
  phMax Decimal?
  phMin Decimal?
  notesConditions String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId Int
  user User @relation(fields: [userId], references: [id])

  sensors Sensor[]
  idealRanges PlantIdealRange[]
  alerts Alert[]
}

model PlantIdealRange {
  id Int @id @default(autoincrement())
  plantId Int
  type String
  unit String
  min Decimal?
  max Decimal?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  plant Plant @relation(fields: [plantId], references: [id], onDelete: Cascade)
}


model Sensor{
  id Int @id @default(autoincrement())
  hardwareId String @unique
  sensorName String
  type String
  unit String
  location String 
  plantId Int?

  alertsEnabled Boolean
  alertMin Decimal?
  alertMax Decimal?

  readingIntervalSeconds Int?
  notes String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  plant Plant? @relation(fields: [plantId], references: [id], onDelete: SetNull)

  userId Int
  user User @relation(fields: [userId], references: [id])

  readings SensorReadings[]

  alertRules SensorAlertRule[]
  alerts Alert[]
}


model SensorReadings{
  id Int @id @default(autoincrement())
  sensorId Int
  value Decimal
  statusReading StatusReading

  createdAt DateTime @default(now())

  sensor Sensor @relation(fields: [sensorId], references: [id], onDelete: Cascade)
}

model AlertRule {
  id Int @id @default(autoincrement())
  name String
  measurementType String
  unit String?
  condition AlertCondition
  threshold Decimal?
  severity AlertSeverity
  enabled Boolean @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId Int
  user User @relation(fields: [userId], references: [id])

  sensors SensorAlertRule[]
  alerts Alert[]
}

model SensorAlertRule {
  id Int @id @default(autoincrement())
  sensorId Int
  alertRuleId Int

  sensor Sensor @relation(fields: [sensorId], references: [id], onDelete: Cascade)
  alertRule AlertRule @relation(fields: [alertRuleId], references: [id], onDelete: Cascade)

  @@unique([sensorId, alertRuleId])
}

model Alert {
  id Int @id @default(autoincrement())
  title String
  description String
  status AlertStatus @default(ATIVO)
  severity AlertSeverity
  value Decimal?
  unit String?
  firedAt DateTime @default(now())
  resolvedAt DateTime?
  resolvedComment String?

  userId Int
  user User @relation(fields: [userId], references: [id])

  plantId Int?
  plant Plant? @relation(fields: [plantId], references: [id], onDelete: SetNull)

  sensorId Int
  sensor Sensor @relation(fields: [sensorId], references: [id], onDelete: Cascade)

  alertRuleId Int?
  alertRule AlertRule? @relation(fields: [alertRuleId], references: [id], onDelete: SetNull)

  resolvedById Int?
  resolvedBy User? @relation("AlertResolvedBy", fields: [resolvedById], references: [id])

  events AlertEvent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AlertEvent {
  id Int @id @default(autoincrement())
  alertId Int
  title String
  message String?
  createdAt DateTime @default(now())

  userId Int?
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  alert Alert @relation(fields: [alertId], references: [id], onDelete: Cascade)
}

